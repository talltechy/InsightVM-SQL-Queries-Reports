vuln_exploit_count AS (
SELECT
CASE WHEN ec1.vulnerability_id IS NOT NULL THEN ec1.vulnerability_id ELSE ec2.vulnerability_id END as vulnerability_id, metasploit, exploitdb
FROM
(SELECT
av.vulnerability_id,
COUNT(dve.source) as metasploit
FROM assets_vulns av
JOIN dim_vulnerability_exploit dve ON av.vulnerability_id = dve.vulnerability_id
WHERE dve.source = 'Metasploit'
GROUP BY
av.vulnerability_id
) ec1
FULL JOIN
(SELECT
av.vulnerability_id,
COUNT(dve.source) as exploitdb
FROM assets_vulns av
JOIN dim_vulnerability_exploit dve ON av.vulnerability_id = dve.vulnerability_id
WHERE dve.source = 'Exploit DB'
GROUP BY
av.vulnerability_id
) ec2
ON ec2.vulnerability_id = ec1.vulnerability_id
)
--END vuln_exploit_count