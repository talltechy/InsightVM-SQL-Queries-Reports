WITH
-- 9/6/2019 - Written by Matt Wyen
        asset_vuln_age AS (
                        SELECT fav.asset_id
                                ,fav.vulnerability_id
                                ,date_part('days', (CURRENT_DATE - MIN(fasv.date)) + INTERVAL '1 day') AS age
                        FROM fact_asset_scan_vulnerability_instance fasv
                        JOIN fact_asset_vulnerability_instance fav ON fasv.asset_id = fav.asset_id
                        AND fasv.vulnerability_id = fav.vulnerability_id
                        GROUP BY fav.asset_id
                                ,fav.vulnerability_id
        ),
        asset_metadata AS (
                        SELECT da.asset_id
                                ,ds.name AS site_name
                                ,da.ip_address AS ip_address
                                ,UPPER(regexp_replace(da.host_name, '([\.][\w\.]+)', '', 'g')) AS hostname
                        FROM dim_asset da
                        JOIN dim_site_asset dsa ON dsa.asset_id = da.asset_id
                        JOIN dim_site ds ON ds.site_id = dsa.site_id
        )
SELECT vfa.asset_id
        ,am.site_name
        ,am.ip_address
        ,am.hostname
        ,CASE
                WHEN am.hostname = ' ' THEN vfa.asset_id::TEXT
                WHEN am.hostname IS NULL THEN vfa.asset_id::TEXT
                WHEN am.hostname IS NOT NULL THEN am.hostname
                ELSE vfa.asset_id::TEXT
        END as "Hostname Replace Blank"
        ,vfa.vulnerability_title
        ,vfa.vulnerability_id
        ,vfa.nexpose_id
        ,vfa.severity
        ,vfa.vuln_count
        ,vfa.age
        ,CASE
                WHEN vfa.age < 30 THEN '<30'
                WHEN vfa.age >= 30 and vfa.age < 60 THEN '30-60'
                WHEN vfa.age >= 60 and vfa.age < 90 THEN '60-90'
                ELSE '90+'
        END as "Aging"
FROM (-- List the age of vuln findings in scope, along with their title, site/asset information, and instance count
        SELECT avd.asset_id
        ,dv.title AS vulnerability_title
        ,dv.severity
        ,dv.vulnerability_id
        ,dv.nexpose_id
        ,dv.date_published AS vulnerability_date_published
        ,dv.date_added AS vulnerability_date_added
        ,dv.date_modified AS vulnerability_date_modified
        ,avd.vuln_count
        ,avd.age
        FROM (
                SELECT fav.asset_id
                        ,fav.vulnerability_id
                        ,1 AS vuln_count
                        ,ava.age
                FROM asset_vuln_age ava
                JOIN fact_asset_vulnerability_finding fav ON fav.asset_id = ava.asset_id AND fav.vulnerability_id = ava.vulnerability_id
                GROUP BY fav.asset_id
                        ,fav.vulnerability_id
                        ,ava.age
        ) avd
        JOIN dim_vulnerability dv ON dv.vulnerability_id = avd.vulnerability_id
) vfa
JOIN asset_metadata am ON am.asset_id = vfa.asset_id
ORDER BY site_name
         ,ip_address
         ,vulnerability_title