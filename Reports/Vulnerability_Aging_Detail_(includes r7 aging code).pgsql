WITH
-- 9/6/2019 - Written by Matt Wyen
-- Version: 2.6.3
-- Moderate revision change, 2.5.1 caused issues with the sub-query, causing a 600MB CSV file to generate
        asset_metadata AS (
                        SELECT fa.asset_id
                                ,da.ip_address
                                -- UPPER wraps the Regex and formats as uppercase
                                -- regexp_replace takes the hostname and removes all the DNS extras such as .forchtgroup.us and leaves only FG00001111 regular asset names
                                ,UPPER(regexp_replace(da.host_name, '([\.][\w\.]+)', '', 'g')) AS hostname
                                -- This is an aggregate of all sites this asset belongs to, dont be surprised if you see more than what you filtered on via the console
                                ,da.sites
                                -- This makes the risk score legible and gets rid of extra decimal places
                                -- This specific riskscore is for the total asset risk
                                ,round(fa.riskscore::numeric, 0) AS total_asset_risk
                                -- Total asset vulnerabilities (aggregate)
                                ,fa.critical_vulnerabilities AS total_asset_critical
                                ,fa.severe_vulnerabilities AS total_asset_severe
                                ,fa.moderate_vulnerabilities AS total_asset_moderate
                        FROM fact_asset fa 
                        JOIN dim_asset da ON fa.asset_id = da.asset_id
        ),
        /* Level of Grain: A vulnerability on an asset.
         * Fact Type: accumulating snapshot
         * Description: This fact table provides an accumulating snapshot for vulnerability age and occurrence information on an asset.
         * For every vulnerability to which an asset is currently vulnerable, there will be one fact record.
         * The record indicates when the vulnerability was first found, last found, and its current age.
         * The age is computed as the difference between the time the vulnerability was first discovered on the asset, and the current time.
         * If the vulnerability was temporarily remediated, but rediscovered, the age will be from the first discovery time.
         * If a vulnerability was found on a service, remediated and discovered on another service,
         * the age is still computed as the first time the vulnerability was found on any service on the asset.
        */
        r7_aging AS (
                        SELECT asset_id
                                ,vulnerability_id
                                ,TRUNC(
                                age_in_days,
                                2
                                ) AS age_in_days_trunc
                                ,CASE
                                        WHEN age_in_days < 30 THEN '<30'
                                        WHEN age_in_days >= 30 and age_in_days < 60 THEN '30-60'
                                        WHEN age_in_days >= 60 and age_in_days < 90 THEN '60-90'
                                        ELSE '90+'
                                END as aging
                                ,first_discovered
                                ,most_recently_discovered
                        FROM fact_asset_vulnerability_age
        )
SELECT vfa.asset_id
        -- Reference of the all sites aggregate from asset metadata
        ,am.sites AS "All Sites"
        ,am.ip_address
        -- This calls the already formatted hostname from asset_metadata and runs a CASE statement to replace blank values with the word blank for formatting/sorting purposes
        ,CASE
                WHEN am.hostname = ' ' THEN vfa.asset_id::TEXT
                WHEN am.hostname IS NULL THEN vfa.asset_id::TEXT
                WHEN am.hostname IS NOT NULL THEN am.hostname
                ELSE vfa.asset_id::TEXT
        END as "Hostname"
        ,vfa.vulnerability_title
        ,vfa.vulnerability_id
        ,vfa.nexpose_id
        -- Preformated severity
        ,vfa.severity
        -- Legible riskscore
        ,vfa.risk AS "Individual Vulnerability Risk"
        ,am.total_asset_risk AS "Total Asset Risk"
        ,vfa.exploits
        ,vfa.malware_kits
        ,am.total_asset_critical AS "Total Asset Critical"
        ,am.total_asset_severe AS "Total Asset Severe"
        ,am.total_asset_moderate "Total Asset Moderate"
        ,vfa.r7a_age AS "R7 Age Interval Format"
        ,vfa.r7a_aging AS "R7 Aging"
        ,vfa.r7a_age_in_days AS "R7 Age-in-Days"
        ,vfa.r7a_first_discovered AS "R7 Vulnerability First Discovered on Asset"
        ,vfa.r7a_most_recently_discovered AS "R7 Vulnerability Most Receently Discovered on Asset"
        ,vfa.vulnerability_date_published
        ,vfa.vulnerability_date_added
        ,vfa.vulnerability_date_modified
FROM ( -- List the age of vuln findings in scope, along with their title, site/asset information, and instance count
        SELECT avd.asset_id
                ,dv.title AS vulnerability_title
                ,dv.vulnerability_id
                ,dv.nexpose_id
                -- Preformated severity
                ,dv.severity
                -- This makes the risk score legible and gets rid of extra decimal places
                -- This specific riskscore is only for individual vulnerability risk NOT total asset risk
                ,round(dv.riskscore::numeric, 0) AS risk
                ,dv.exploits
                ,dv.malware_kits
                ,dv.date_published AS vulnerability_date_published
                ,dv.date_added AS vulnerability_date_added
                ,dv.date_modified AS vulnerability_date_modified
                ,avd.r7a_age
                ,avd.r7a_aging
                ,avd.r7a_age_in_days
                ,avd.r7a_first_discovered
                ,avd.r7a_most_recently_discovered
        FROM (
                SELECT favf.asset_id
                        ,favf.vulnerability_id
                        ,r7a.age_in_days_trunc AS r7a_age_in_days
                        ,r7a.aging AS r7a_aging
                        ,r7a.first_discovered AS r7a_first_discovered
                        ,r7a.most_recently_discovered AS r7a_most_recently_discovered
                FROM r7_aging r7a
                JOIN fact_asset_vulnerability_finding favf ON favf.asset_id = r7a.asset_id AND favf.vulnerability_id = r7a.vulnerability_id
                -- GROUP BY favf.asset_id
                --         ,favf.vulnerability_id
                --         ,r7a.age_in_days_trunc
                --         ,r7a.aging
                --         ,r7a.first_discovered
                --         ,r7a.most_recently_discovered
        ) avd
        JOIN dim_vulnerability dv ON dv.vulnerability_id = avd.vulnerability_id
) vfa
JOIN asset_metadata am ON vfa.asset_id = am.asset_id
-- Note there is no WHERE clause on purpose, you have to filter assets via the InsightVM console SQL report - You select an Asset, Site or Asset Group
ORDER BY asset_id
        ,vulnerability_title
        ,severity