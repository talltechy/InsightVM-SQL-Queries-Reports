WITH
    asset_metadata AS (
                SELECT fa.asset_id
                        ,da.ip_address
                        -- UPPER wraps the Regex and formats as uppercase
                        -- regexp_replace takes the hostname and removes all the DNS extras such as .exampledomain.tld and leaves only regular asset names
                        ,UPPER(regexp_replace(da.host_name, '([\.][\w\.]+)','','g')) AS hostname
                        -- This makes the risk score legible and gets rid of extra decimal places
                        -- This specific risk score is for the total asset risk
                        ,round(fa.risk_score::numeric,0) AS total_asset_risk
                        -- Total asset vulnerabilities (aggregate)
                        ,fa.critical_vulnerabilities AS total_asset_critical
                        ,fa.severe_vulnerabilities AS total_asset_severe
                        ,fa.moderate_vulnerabilities AS total_asset_moderate
                FROM fact_asset fa
                LEFT JOIN dim_asset da ON fa.asset_id = da.asset_id
                WHERE fa.asset_id IS NOT NULL
        ),
        asset_group AS (
                SELECT dag.name AS asset_group_name
                        ,dag.description AS asset_group_description
                        ,daga.asset_id
                        ,daga.asset_group_id
                FROM dim_asset_group dag
                LEFT JOIN dim_asset_group_asset daga ON daga.asset_group_id = dag.asset_group_id
        ),
        vulnerability_exception AS (
                SELECT dve.vulnerability_exception_id
                        ,dve.scope AS exception_scope
                        ,dve.status AS exception_status
                        ,dve.reason AS exception_reason
                        ,dve.asset_id
                        --,dve.site_id
                        ,dve.group_id
                        ,dv.nexpose_id
                        ,dv.title
                        ,dv.severity
                        ,dv.cvss_score
                        ,round(dv.risk_score::numeric,0) AS vulnerability_risk
                        ,dve.additional_comments
                        ,dve.review_comment
                        ,dve.expiration_date
                FROM dim_vulnerability_exception dve
                LEFT OUTER JOIN dim_vulnerability dv ON dv.vulnerability_id = dve.vulnerability_id
                WHERE dve.expiration_date >= current_date
                    OR dve.expiration_date IS NULL
        )
SELECT DISTINCT fae.asset_id
        ,am.ip_address
        ,am.hostname
        ,am.total_asset_risk
        ,ve.exception_scope
        ,ve.exception_status
        ,ve.exception_reason
        ,ve.nexpose_id
        ,ve.title AS "Vulnerability Title"
        ,ve.severity
        ,ve.cvss_score
        ,ve.vulnerability_risk
        ,ag.asset_group_name
        ,ve.additional_comments
        ,ve.review_comment
        ,ve.expiration_date
FROM fact_asset_event fae
LEFT OUTER JOIN vulnerability_exception ve ON fae.vulnerability_exception_id = ve.vulnerability_exception_id
LEFT OUTER JOIN asset_metadata am ON fae.asset_id = am.asset_id
LEFT OUTER JOIN asset_group ag ON fae.asset_id = ag.asset_id AND ve.group_id = ag.asset_group_id
WHERE fae.vulnerability_exception_id IS NOT NULL
    AND ve.exception_status = ('Approved')
    -- you must select a group_id here or comment out the group_id
    -- get it by querying SELECT * FROM dim_asset_group
    AND ve.group_id = ('72')
